# Algo-trade Monitoring Infrastructure

Comprehensive monitoring stack for the 3-plane trading system using Prometheus and Grafana.

## ðŸ“Š Overview

This monitoring infrastructure provides:
- **27+ Prometheus metrics** across Data, Order, and Strategy planes
- **Real-time dashboards** via Grafana
- **HTTP /metrics endpoints** for each service
- **Health checks** for all services
- **Docker Compose** setup for easy deployment

## ðŸš€ Quick Start

### Start Monitoring Stack

```bash
# Start Prometheus + Grafana
cd infrastructure
docker-compose -f docker-compose.monitoring.yml up -d

# Access Grafana
open http://localhost:3000
# Default credentials: admin/admin

# Access Prometheus
open http://localhost:9090
```

### Start Application Metrics Exporters

```bash
# Data Plane metrics on port 8000
python -m data_plane.monitoring.metrics_server data_plane 8000 &

# Order Plane metrics on port 8001
python -m data_plane.monitoring.metrics_server order_plane 8001 &

# Strategy Plane metrics on port 8002
python -m data_plane.monitoring.metrics_server strategy_plane 8002 &
```

### View Metrics

```bash
# Data Plane metrics
curl http://localhost:8000/metrics

# Order Plane metrics
curl http://localhost:8001/metrics

# Strategy Plane metrics
curl http://localhost:8002/metrics

# Health checks
curl http://localhost:8000/health
curl http://localhost:8001/health
curl http://localhost:8002/health
```

## ðŸ“ˆ Available Metrics

### Data Plane (Port 8000)

**Ingestion Metrics:**
- `data_ticks_received_total` - Total tick events received
- `data_bars_received_total` - Total bar events received
- `data_ofi_events_generated_total` - Total OFI events generated

**Quality Metrics:**
- `data_freshness_seconds` - Data freshness histogram
- `data_completeness_score` - Data completeness gauge (0-1)

**Validation Metrics:**
- `data_validation_errors_total` - Validation errors
- `data_ntp_rejects_total` - NTP clock drift rejections
- `data_normalization_errors_total` - Normalization errors
- `data_dlq_messages_total` - DLQ message count

**Storage Metrics:**
- `data_storage_writes_total` - Storage write counter
- `data_storage_write_latency_seconds` - Write latency histogram

### Order Plane (Port 8001)

**Execution Metrics:**
- `orders_received_total` - Order intents received
- `orders_submitted_total` - Orders submitted to broker
- `orders_filled_total` - Orders filled
- `orders_rejected_total` - Orders rejected

**Latency Metrics:**
- `orders_intent_to_submit_latency_seconds` - Intentâ†’Submit latency
- `orders_submit_to_ack_latency_seconds` - Submitâ†’Ack latency
- `orders_ack_to_fill_latency_seconds` - Ackâ†’Fill latency
- `orders_total_fill_latency_seconds` - Total fill latency

**Cost Metrics:**
- `orders_slippage_bps` - Slippage in basis points
- `orders_commission_total_usd` - Total commission paid

**Risk Metrics:**
- `orders_risk_rejections_total` - Risk check rejections
- `orders_pov_downscales_total` - POV limit downscales

### Strategy Plane (Port 8002)

**Signal Metrics:**
- `strategy_signals_generated_total` - Signals generated by strategy
- `strategy_signal_strength` - Signal strength distribution

**Portfolio Metrics:**
- `strategy_portfolio_gross_exposure_usd` - Gross exposure
- `strategy_portfolio_net_exposure_usd` - Net exposure
- `strategy_portfolio_value_usd` - Total portfolio value

**PnL Metrics:**
- `strategy_pnl_realized_usd` - Realized PnL
- `strategy_pnl_unrealized_usd` - Unrealized PnL
- `strategy_pnl_total_usd` - Total PnL

**Regime Metrics:**
- `strategy_regime_state` - Current market regime (0=Calm, 1=Normal, 2=Storm)
- `strategy_regime_transitions_total` - Regime transitions

**Optimization Metrics:**
- `strategy_qp_solve_time_seconds` - QP solver time
- `strategy_qp_solve_status_total` - QP solver status

**Kill Switch Metrics:**
- `strategy_kill_switches_triggered_total` - Kill switch triggers
- `strategy_kill_switch_active` - Kill switch active status

## ðŸ”§ Configuration

### Prometheus Configuration

Edit `prometheus/prometheus.yml` to configure:
- Scrape intervals
- Target endpoints
- Alert rules (optional)
- Service discovery

### Grafana Configuration

**Auto-provisioned:**
- Prometheus datasource (`grafana/datasources/prometheus.yml`)
- Dashboards (`grafana/dashboards/`)

**Manual Configuration:**
1. Login to Grafana (http://localhost:3000)
2. Add Prometheus datasource (already configured)
3. Import dashboards from `grafana/dashboards/`

## ðŸ“Š Metrics Labels

All metrics include labels for filtering and aggregation:

**Common Labels:**
- `symbol` - Asset symbol (e.g., SPY, TSLA)
- `source` - Data source (e.g., ibkr_rt, ibkr_hist)
- `service` - Service name

**Data Plane Labels:**
- `duration` - Bar duration (1m, 5m, 1h, 1d)
- `error_type` - Validation error type
- `event_type` - Event type (bar, tick, ofi)

**Order Plane Labels:**
- `strategy` - Strategy name (OFI, ERN, VRP, etc.)
- `order_type` - Order type (MARKET, LIMIT, STOP)
- `direction` - Order direction (BUY, SELL)
- `status` - Fill status (FILLED, PARTIAL_FILL, REJECTED)
- `reason` - Rejection reason
- `check_type` - Risk check type

**Strategy Plane Labels:**
- `strategy` - Strategy name
- `direction` - Signal direction (BUY, SELL)
- `from_regime` / `to_regime` - Regime transition
- `switch_type` - Kill switch type (pnl, drawdown, psr)
- `status` - QP solver status

## ðŸ³ Docker Compose Services

### Prometheus
- **Port:** 9090
- **Data Retention:** 30 days
- **Config:** `prometheus/prometheus.yml`
- **Volume:** `prometheus_data`

### Grafana
- **Port:** 3000
- **Credentials:** admin/admin (CHANGE IN PRODUCTION)
- **Datasources:** Auto-provisioned from `grafana/datasources/`
- **Dashboards:** Auto-provisioned from `grafana/dashboards/`
- **Volume:** `grafana_data`

## ðŸ” Usage Examples

### Python Code Integration

```python
from data_plane.monitoring.metrics_exporter import init_metrics_exporter
from data_plane.monitoring.metrics_server import start_metrics_server

# Initialize metrics
metrics = init_metrics_exporter('data_plane')

# Track metrics
metrics.inc('ticks_received', source='ibkr_rt', symbol='SPY')
metrics.observe('data_freshness', 0.150, source='ibkr_rt', symbol='SPY')
metrics.set('completeness_score', 0.95, symbol='SPY')

# Start metrics server
server = await start_metrics_server(metrics, port=8000)
```

### PromQL Queries

```promql
# Data ingestion rate (ticks/second)
rate(data_ticks_received_total[1m])

# Average fill latency by symbol
histogram_quantile(0.95, rate(orders_total_fill_latency_seconds_bucket[5m])) by (symbol)

# Total PnL
strategy_pnl_total_usd

# Kill switch status
strategy_kill_switch_active{switch_type="pnl"}

# Error rate
rate(data_validation_errors_total[1m])
```

## ðŸ“ Maintenance

### Backup Prometheus Data

```bash
docker-compose -f docker-compose.monitoring.yml exec prometheus tar czf /tmp/prometheus-backup.tar.gz /prometheus
docker cp algo-trade-prometheus:/tmp/prometheus-backup.tar.gz ./backups/
```

### Backup Grafana Dashboards

```bash
docker-compose -f docker-compose.monitoring.yml exec grafana tar czf /tmp/grafana-backup.tar.gz /var/lib/grafana
docker cp algo-trade-grafana:/tmp/grafana-backup.tar.gz ./backups/
```

### Reload Prometheus Config

```bash
# Send HUP signal to Prometheus
docker-compose -f docker-compose.monitoring.yml exec prometheus kill -HUP 1

# Or use API
curl -X POST http://localhost:9090/-/reload
```

## ðŸš¨ Alerting (Optional)

### Configure Alertmanager

1. Create `prometheus/alerts.yml`:

```yaml
groups:
  - name: trading_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: rate(data_validation_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High validation error rate"

      - alert: KillSwitchTriggered
        expr: strategy_kill_switch_active > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kill switch triggered: {{ $labels.switch_type }}"
```

2. Add Alertmanager to `docker-compose.monitoring.yml`
3. Configure notification channels (email, Slack, PagerDuty)

## ðŸ”— Resources

- [Prometheus Documentation](https://prometheus.io/docs/)
- [Grafana Documentation](https://grafana.com/docs/)
- [PromQL Cheat Sheet](https://promlabs.com/promql-cheat-sheet/)
- [Prometheus Best Practices](https://prometheus.io/docs/practices/)

## ðŸ“ž Troubleshooting

**Metrics not appearing in Prometheus:**
1. Check if metrics endpoint is accessible: `curl http://localhost:8000/metrics`
2. Verify Prometheus scrape config
3. Check Prometheus targets: http://localhost:9090/targets

**Grafana can't connect to Prometheus:**
1. Verify datasource URL in Grafana settings
2. Check Docker network connectivity
3. Restart Grafana: `docker-compose restart grafana`

**High memory usage:**
1. Reduce Prometheus retention: `--storage.tsdb.retention.time=7d`
2. Increase scrape intervals
3. Reduce cardinality (fewer label combinations)

---

**Last Updated:** November 2025
