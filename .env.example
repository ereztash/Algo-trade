# =============================================================================
# Algo-Trade Paper Trading Environment Configuration
# =============================================================================
# Copy this file to .env and fill in your actual values
# DO NOT commit .env to git - it contains sensitive credentials
# =============================================================================

# -----------------------------------------------------------------------------
# Environment Configuration
# -----------------------------------------------------------------------------
ENVIRONMENT=paper                    # Options: dev, paper, prod
LOG_LEVEL=INFO                       # Options: DEBUG, INFO, WARNING, ERROR, CRITICAL

# -----------------------------------------------------------------------------
# Kafka Configuration
# -----------------------------------------------------------------------------
KAFKA_BOOTSTRAP_SERVERS=localhost:9092
KAFKA_SECURITY_PROTOCOL=PLAINTEXT    # Options: PLAINTEXT, SASL_SSL, SSL
KAFKA_CLIENT_ID=algo-trade-client
KAFKA_CONSUMER_GROUP=algo-trade-group

# Kafka Performance Tuning
KAFKA_BATCH_SIZE=16384               # Producer batch size (bytes)
KAFKA_LINGER_MS=10                   # Producer linger time (milliseconds)
KAFKA_COMPRESSION_TYPE=snappy        # Options: none, gzip, snappy, lz4, zstd
KAFKA_MAX_IN_FLIGHT_REQUESTS=5
KAFKA_ACKS=all                       # Options: 0, 1, all (for durability)

# Kafka Consumer Configuration
KAFKA_AUTO_OFFSET_RESET=latest       # Options: earliest, latest
KAFKA_ENABLE_AUTO_COMMIT=true
KAFKA_AUTO_COMMIT_INTERVAL_MS=5000
KAFKA_SESSION_TIMEOUT_MS=30000
KAFKA_MAX_POLL_RECORDS=500

# Kafka SASL/SSL (for production - leave empty for dev)
KAFKA_SASL_MECHANISM=                # Options: PLAIN, SCRAM-SHA-256, SCRAM-SHA-512
KAFKA_SASL_USERNAME=
KAFKA_SASL_PASSWORD=
KAFKA_SSL_CA_LOCATION=
KAFKA_SSL_CERT_LOCATION=
KAFKA_SSL_KEY_LOCATION=

# -----------------------------------------------------------------------------
# Interactive Brokers (IBKR) Configuration
# -----------------------------------------------------------------------------

# IBKR Connection
IBKR_HOST=127.0.0.1                  # Must be localhost for security
IBKR_PORT=4002                       # Paper: 4002 (Gateway) or 7497 (TWS) | Live: 4001 or 7496
IBKR_CLIENT_ID=1                     # Unique client ID (1-32)
IBKR_ACCOUNT_ID=                     # Paper: DU1234567 | Live: U1234567 (FILL THIS IN)

# IBKR Paper/Live Mode
IBKR_PAPER_MODE=true                 # CRITICAL: true=Paper, false=Live
IBKR_READ_ONLY=false                 # Set to true for Stage 6 validation (read-only probe)

# IBKR Connection Settings
IBKR_TIMEOUT_SEC=10
IBKR_RECONNECT_ATTEMPTS=3
IBKR_RECONNECT_BACKOFF_SEC=2

# IBKR Credentials (if using TWS login)
IBKR_USERNAME=                       # TWS username (optional - login manually via TWS/Gateway)
IBKR_PASSWORD=                       # TWS password (optional - not recommended, use manual login)

# IBKR API Rate Limits (enforced client-side)
IBKR_ORDER_RATE_LIMIT=50             # Orders per second
IBKR_HIST_DATA_RATE_LIMIT=60         # Historical data requests per 10 minutes
IBKR_MARKET_DATA_SUBSCRIPTIONS=100   # Max simultaneous market data subscriptions

# -----------------------------------------------------------------------------
# Vault Configuration (Optional - for secure credential storage)
# -----------------------------------------------------------------------------
USE_VAULT=false                      # Enable Vault for secrets management
VAULT_ADDR=https://vault.example.com
VAULT_TOKEN=                         # Vault authentication token
VAULT_PATH=secret/data/algo-trade    # Vault secret path

# Vault Secret Paths
VAULT_BROKER_PATH=secret/data/broker      # IBKR credentials
VAULT_KAFKA_PATH=secret/data/kafka        # Kafka SASL credentials

# -----------------------------------------------------------------------------
# Data Plane Configuration
# -----------------------------------------------------------------------------
DP_BROKER__NAME=IBKR
DP_BROKER__HOST=${IBKR_HOST}
DP_BROKER__PORT=${IBKR_PORT}
DP_BROKER__PAPER=${IBKR_PAPER_MODE}

# Market Data Settings
DP_MARKET_DATA_SYMBOLS=SPY,QQQ,IWM   # Comma-separated list of symbols
DP_REALTIME_BAR_SIZE=5               # Real-time bar size in seconds (5, 10, 15, 30)
DP_HISTORICAL_DURATION=1D            # Historical data duration (1D, 1W, 1M)
DP_HISTORICAL_BAR_SIZE=1min          # Historical bar size (1min, 5min, 15min, 1hour, 1day)

# -----------------------------------------------------------------------------
# Strategy Plane Configuration
# -----------------------------------------------------------------------------

# OFI Strategy Parameters
STRATEGY_OFI_ENABLED=true
STRATEGY_OFI_WINDOW_SIZE=20          # Rolling window for OFI calculation
STRATEGY_OFI_THRESHOLD=2.0           # Z-score threshold for signal generation
STRATEGY_OFI_MAX_POSITIONS=2         # Max number of concurrent positions

# Strategy Risk Limits
STRATEGY_MAX_POSITION_SIZE=100       # Max shares per position
STRATEGY_MAX_GROSS_EXPOSURE=10000    # Max gross exposure (USD)
STRATEGY_MAX_NET_EXPOSURE=5000       # Max net exposure (USD)

# -----------------------------------------------------------------------------
# Order Plane Configuration
# -----------------------------------------------------------------------------

# Order Execution Settings
ORDER_DEFAULT_TYPE=LIMIT             # Default order type: MARKET, LIMIT, ADAPTIVE
ORDER_TIME_IN_FORCE=DAY              # DAY, GTC, IOC, FOK
ORDER_URGENCY=NORMAL                 # LOW, NORMAL, HIGH, URGENT

# Pre-Trade Risk Checks
RISK_ENABLE_BOX_LIMIT=true           # Enable box limit check
RISK_BOX_LIMIT_USD=10000             # Box limit (max gross exposure)
RISK_ENABLE_GROSS_LIMIT=true
RISK_GROSS_LIMIT_USD=10000
RISK_ENABLE_NET_LIMIT=true
RISK_NET_LIMIT_USD=5000

# Kill Switches
RISK_ENABLE_PNL_KILL_SWITCH=true
RISK_PNL_KILL_SWITCH_USD=-100        # Stop trading if PnL < -$100
RISK_ENABLE_DRAWDOWN_KILL_SWITCH=true
RISK_DRAWDOWN_KILL_SWITCH_PCT=5      # Stop trading if drawdown > 5%

# -----------------------------------------------------------------------------
# Monitoring & Observability
# -----------------------------------------------------------------------------

# Prometheus
PROMETHEUS_PORT=9090
PROMETHEUS_METRICS_PATH=/metrics
PROMETHEUS_SCRAPE_INTERVAL=15s       # How often to scrape metrics

# Grafana
GRAFANA_PORT=3000
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=admin         # CHANGE THIS IN PRODUCTION

# Metrics Export
METRICS_EXPORT_ENABLED=true
METRICS_EXPORT_PORT=9091             # Application metrics port
METRICS_EXPORT_INTERVAL_SEC=10

# Logging
LOG_FILE_PATH=./logs/algo-trade.log
LOG_MAX_BYTES=10485760               # 10MB per log file
LOG_BACKUP_COUNT=5                   # Keep 5 backup log files
LOG_FORMAT=json                      # Options: json, text

# -----------------------------------------------------------------------------
# Testing & Development
# -----------------------------------------------------------------------------

# Mock/Simulation Mode
MOCK_MODE=false                      # Use mock broker instead of real IBKR
MOCK_LATENCY_MS=50                   # Simulated latency for mock broker

# Chaos Engineering (for testing resilience)
CHAOS_ENABLED=false
CHAOS_KAFKA_DISCONNECT_PROB=0.01     # 1% chance of Kafka disconnect per minute
CHAOS_IBKR_DISCONNECT_PROB=0.01      # 1% chance of IBKR disconnect per minute
CHAOS_MESSAGE_DROP_PROB=0.001        # 0.1% chance of dropping a message

# -----------------------------------------------------------------------------
# Advanced Configuration
# -----------------------------------------------------------------------------

# Message Validation
VALIDATION_MODE=BOTH                 # Options: PYDANTIC_ONLY, JSON_SCHEMA_ONLY, BOTH
VALIDATION_DLQ_ENABLED=true
VALIDATION_FAIL_FAST=false           # Stop on first validation error

# Performance Tuning
ASYNCIO_WORKER_THREADS=4
MAX_CONCURRENT_ORDERS=10
MESSAGE_QUEUE_SIZE=1000

# Kafka Topic Names (override defaults from contracts/topics.yaml)
TOPIC_MARKET_RAW=market_raw
TOPIC_MARKET_EVENTS=market_events
TOPIC_OFI_EVENTS=ofi_events
TOPIC_ORDER_INTENTS=order_intents
TOPIC_EXEC_REPORTS=exec_reports
TOPIC_DLQ_MARKET_EVENTS=dlq_market_events
TOPIC_DLQ_ORDER_INTENTS=dlq_order_intents
TOPIC_DLQ_EXEC_REPORTS=dlq_exec_reports

# -----------------------------------------------------------------------------
# Stage 7 Validation Settings (6-hour Paper Trading Session)
# -----------------------------------------------------------------------------
STAGE7_ENABLED=false                 # Enable Stage 7 validation mode
STAGE7_DURATION_HOURS=6              # Session duration
STAGE7_MIN_ORDERS=10                 # Minimum orders to consider success
STAGE7_TARGET_FILL_RATE=0.70         # 70% fill rate target
STAGE7_MAX_LATENCY_P95_MS=500        # p95 latency target (intent â†’ fill)
STAGE7_SYMBOLS=SPY,QQQ               # Symbols for Stage 7 testing
STAGE7_MAX_POSITION_SIZE=10          # Conservative position sizing for Stage 7
STAGE7_MAX_GROSS_EXPOSURE=1000       # $1000 max exposure for Stage 7

# =============================================================================
# SECURITY NOTES:
# =============================================================================
# 1. NEVER commit .env file to git (add to .gitignore)
# 2. IBKR credentials should NEVER be stored in plain text
#    - Option A: Use manual TWS/Gateway login (recommended)
#    - Option B: Use Vault for credential storage
# 3. IBKR_HOST must ALWAYS be 127.0.0.1 (localhost only)
#    - NEVER expose IBKR ports to the internet
# 4. Use IBKR_PAPER_MODE=true until all validations pass
# 5. Change Grafana admin password in production
# 6. For production, enable Kafka SASL/SSL authentication
# =============================================================================
