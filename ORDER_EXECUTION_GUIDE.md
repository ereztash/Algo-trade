# Order Execution Guide - IBKR Integration

Complete guide for live/paper trading order execution through Interactive Brokers.

---

## Overview

The Order Plane is responsible for executing trading orders generated by the Strategy Plane. It handles:
- ✅ Order placement with IBKR (Market, Limit, Stop orders)
- ✅ Order status tracking and updates
- ✅ Fill confirmations and partial fills
- ✅ Order cancellation
- ✅ Execution report publishing to Kafka
- ✅ Pre-trade risk validation

---

## Architecture

### Data Flow
```
Strategy Plane
      ↓
Kafka (order_intents)
      ↓
Order Orchestrator
      ↓
IBKRExecClient ←→ IBKR Gateway/TWS
      ↓
Execution Reports
      ↓
Kafka (exec_reports)
      ↓
Strategy Plane (feedback loop)
```

### Components

#### 1. **IBKRExecClient** (`order_plane/broker/ibkr_exec_client.py`)
Low-level IBKR API client handling direct communication with IBKR Gateway/TWS.

**Key Features:**
- Asynchronous connection management
- Order placement (`place_order()`)
- Order cancellation (`cancel_order()`)
- Callback handlers for order status updates
- Execution detail tracking
- Commission reporting

**Main Classes:**
- `IBKRExecClient`: Main client (extends `EClient`)
- `IBKRExecutionWrapper`: Callback handler (extends `EWrapper`)
- `OrderState`: Order state tracking dataclass
- `OrderStatus`: Order lifecycle enum

#### 2. **OrderOrchestrator** (`order_plane/app/order_orchestrator.py`)
High-level orchestration of the order execution workflow.

**Responsibilities:**
- Consume order intents from Kafka
- Validate orders (pre-trade risk checks)
- Submit orders to IBKR
- Monitor order status
- Publish execution reports to Kafka

---

## Order Lifecycle

### State Transitions
```
OrderIntent (Kafka)
      ↓
[Validation] → Risk checks
      ↓
PendingSubmit
      ↓
PreSubmitted (IBKR internal)
      ↓
Submitted (acknowledged by broker)
      ↓
[PartiallyFilled] (optional)
      ↓
Filled (complete)
      ↓
ExecutionReport (Kafka)
```

### Order States

| State | Description | Next States |
|-------|-------------|-------------|
| `PendingSubmit` | Order created, waiting to be sent | `PreSubmitted`, `Cancelled` |
| `PreSubmitted` | Received by IBKR, being processed | `Submitted`, `Cancelled` |
| `Submitted` | Active in the market | `PartiallyFilled`, `Filled`, `Cancelled` |
| `PartiallyFilled` | Some shares filled | `PartiallyFilled`, `Filled` |
| `Filled` | All shares filled | (terminal state) |
| `Cancelled` | Order cancelled | (terminal state) |

---

## Usage

### 1. Initialize IBKR Client

```python
from order_plane.broker.ibkr_exec_client import IBKRExecClient

# Configuration
config = {
    'host': '127.0.0.1',      # IBKR Gateway/TWS host
    'port': 4002,              # 4002 = paper, 4001 = live
    'client_id': 2             # Unique client ID
}

# Create client
ibkr_client = IBKRExecClient(config)

# Connect
connected = await ibkr_client.connect_async()
if not connected:
    raise Exception("Failed to connect to IBKR")
```

### 2. Place an Order

```python
# Create order intent
order_intent = {
    'intent_id': 'unique-uuid-here',
    'symbol': 'SPY',
    'direction': 'BUY',         # or 'SELL'
    'quantity': 100,
    'order_type': 'MARKET',     # or 'LIMIT', 'STOP'
    'limit_price': 450.00,      # for LIMIT orders
    'strategy_id': 'momentum_v1',
    'signal_strength': 0.75
}

# Place order
ibkr_order_id = await ibkr_client.place_order(order_intent)

if ibkr_order_id:
    print(f"Order placed successfully: ID={ibkr_order_id}")
else:
    print("Order placement failed")
```

### 3. Monitor Order Status

```python
# Get order state by intent ID
order_state = ibkr_client.get_order_state(intent_id='unique-uuid-here')

if order_state:
    print(f"Status: {order_state.status.value}")
    print(f"Filled: {order_state.filled_quantity}/{order_state.quantity}")
    print(f"Avg Price: ${order_state.avg_fill_price:.2f}")
    print(f"Commission: ${order_state.commission:.2f}")
```

### 4. Get Execution Reports

```python
# Poll for execution reports
reports = await ibkr_client.get_execution_reports()

for report in reports:
    print(f"Order {report['intent_id']} status: {report['status']}")
    print(f"Filled {report['filled_quantity']} @ ${report['avg_fill_price']:.2f}")
```

### 5. Cancel Order

```python
# Cancel by IBKR order ID
await ibkr_client.cancel_order(ibkr_order_id)
```

---

## Order Types

### Market Order
```python
{
    'order_type': 'MARKET',
    'quantity': 100
    # No price specified - executes at current market price
}
```

### Limit Order
```python
{
    'order_type': 'LIMIT',
    'quantity': 100,
    'limit_price': 450.00  # Will not pay more than $450.00 for BUY
}
```

### Stop Order
```python
{
    'order_type': 'STOP',
    'quantity': 100,
    'stop_price': 445.00  # Triggers market order if price hits $445.00
}
```

### Stop Limit Order
```python
{
    'order_type': 'STOP_LIMIT',
    'quantity': 100,
    'stop_price': 445.00,
    'limit_price': 444.00  # Triggers limit order at $444.00 when stop hit
}
```

---

## IBKR Callbacks

The system automatically handles these IBKR callbacks:

### 1. `nextValidId(orderId)`
Called when connection is established. Provides the next valid order ID.

```python
def nextValidId(self, orderId: int):
    """Connection established, can start placing orders."""
    self.next_order_id = orderId
    self.connected = True
```

### 2. `orderStatus(...)`
Called when order status changes (submitted, filled, cancelled, etc.).

```python
def orderStatus(self, orderId, status, filled, remaining, avgFillPrice, ...):
    """
    Status values:
    - PendingSubmit
    - PreSubmitted
    - Submitted
    - Filled
    - Cancelled
    - PartiallyFilled
    """
```

### 3. `execDetails(...)
Called when order is executed (filled).

```python
def execDetails(self, reqId, contract, execution):
    """Provides detailed execution info: price, quantity, exchange, time."""
```

### 4. `commissionReport(...)`
Called after execution with commission details.

```python
def commissionReport(self, commissionReport):
    """Commission amount and currency."""
```

### 5. `error(...)`
Called on errors or informational messages.

```python
def error(self, reqId, errorCode, errorString, ...):
    """
    Error codes:
    - 2104-2106: Informational (connection status)
    - 200-203: Order rejected
    - 300+: System errors
    """
```

---

## Orchestrator Usage

### Full System Integration

```python
from order_plane.app.order_orchestrator import OrderOrchestrator, SimpleRiskChecker
from order_plane.broker.ibkr_exec_client import IBKRExecClient

# Initialize components
ibkr_client = IBKRExecClient(ibkr_config)
risk_checker = SimpleRiskChecker({
    'max_order_quantity': 1000,
    'max_gross_exposure': 1_000_000
})

# Connect to IBKR
await ibkr_client.connect_async()

# Create orchestrator
orchestrator = OrderOrchestrator(
    kafka_consumer=kafka_consumer,  # Consumes order_intents
    kafka_producer=kafka_producer,  # Produces exec_reports
    ibkr_client=ibkr_client,
    risk_checker=risk_checker
)

# Start orchestrator
await orchestrator.start()
```

### Process Single Order Intent

```python
# Process order intent
success = await orchestrator.process_order_intent(order_intent)

if success:
    print("Order placed and tracked")
else:
    print("Order rejected")
```

### Monitor Active Orders

```python
# Get count of active orders
active_count = orchestrator.get_active_orders_count()
print(f"Active orders: {active_count}")

# Get specific order status
status = orchestrator.get_order_status(intent_id='some-uuid')
if status:
    print(f"Order {status['symbol']}: {status['status']}")
```

---

## Risk Validation

### Pre-Trade Risk Checks

The `SimpleRiskChecker` validates orders before submission:

```python
risk_checker = SimpleRiskChecker({
    'max_order_quantity': 1000,        # Max shares per order
    'max_gross_exposure': 1_000_000    # Max total exposure
})

# Validate order
is_valid = risk_checker.validate(order_intent)
```

**Checks Performed:**
1. ✅ Quantity > 0
2. ✅ Quantity <= max_order_quantity
3. ✅ Valid order type (MARKET, LIMIT, STOP, STOP_LIMIT)
4. ✅ Limit orders have limit_price specified
5. ✅ Stop orders have stop_price specified

### Custom Risk Checks

Extend `SimpleRiskChecker` for custom validation:

```python
class CustomRiskChecker(SimpleRiskChecker):
    def validate(self, intent: dict) -> bool:
        # Call parent validation
        if not super().validate(intent):
            return False

        # Custom checks
        if intent['symbol'] in self.blocked_symbols:
            return False

        if self.current_exposure + intent['quantity'] > self.max_gross_exposure:
            return False

        return True
```

---

## Execution Reports

### Report Structure

```python
{
    'execution_id': 'uuid-for-this-execution',
    'intent_id': 'uuid-from-order-intent',
    'ibkr_order_id': 12345,
    'symbol': 'SPY',
    'side': 'BUY',
    'quantity': 100,
    'filled_quantity': 100,
    'avg_fill_price': 451.25,
    'status': 'Filled',
    'commission': 1.00,
    'submitted_at': '2025-11-16T10:30:00Z',
    'filled_at': '2025-11-16T10:30:05Z',
    'executions': [
        {
            'exec_id': 'IB-EXEC-001',
            'time': '2025-11-16T10:30:05',
            'shares': 100,
            'price': 451.25,
            'exchange': 'NASDAQ',
            'side': 'BOT'
        }
    ]
}
```

### Rejection Reports

When orders are rejected (risk checks or IBKR errors):

```python
{
    'execution_id': 'REJ-unique-uuid',
    'intent_id': 'unique-uuid',
    'symbol': 'SPY',
    'side': 'BUY',
    'quantity': 100,
    'filled_quantity': 0.0,
    'avg_fill_price': 0.0,
    'status': 'Rejected',
    'rejection_reason': 'Risk limits exceeded',
    'timestamp': '2025-11-16T10:30:00Z'
}
```

---

## Configuration

### Environment Variables

```bash
# IBKR Connection
IBKR_HOST=127.0.0.1          # IBKR Gateway/TWS host
IBKR_PORT=4002                # 4002=paper, 4001=live
IBKR_CLIENT_ID=2              # Unique client ID (Order Plane uses 2)
IBKR_ACCOUNT=DU123456         # Your IBKR account

# Risk Limits
MAX_ORDER_QUANTITY=1000       # Max shares per order
MAX_GROSS_EXPOSURE=1000000    # Max total exposure ($)

# Monitoring
PROMETHEUS_PORT=8002          # Metrics endpoint
LOG_LEVEL=INFO                # Logging level
```

### IBKR Gateway/TWS Setup

**1. Install IBKR Gateway or TWS**
- Download from: https://www.interactivebrokers.com/
- Paper Trading: Use paper trading account
- Live Trading: Use live account (⚠️ real money!)

**2. Enable API Access**
- Open TWS/Gateway
- Configure → Settings → API → Settings
- ☑ Enable ActiveX and Socket Clients
- ☑ Allow connections from localhost
- Socket port: 4002 (paper) or 4001 (live)
- ☑ Read-Only API (for safety during testing)

**3. Trusted IPs**
- Add 127.0.0.1 to trusted IPs
- Or specific container IP if using Docker

**4. Auto-Restart**
- Configure auto-restart to minimize downtime
- Set auto-logoff time to longer period

---

## Error Handling

### Common Errors

#### 1. Connection Refused
```
Error: Connection refused to 127.0.0.1:4002
```
**Solution**: Verify IBKR Gateway/TWS is running and API is enabled.

#### 2. Order Rejected
```
IBKR Error [201]: Order rejected - Duplicate order
```
**Solutions**:
- Use unique intent_id for each order
- Check if order already exists before placing

#### 3. Timeout
```
Error: Connection to IBKR timed out
```
**Solutions**:
- Check network connectivity
- Verify IBKR Gateway is accepting connections
- Increase timeout in `connect_async()`

#### 4. Invalid Contract
```
IBKR Error [200]: No security definition found
```
**Solutions**:
- Verify symbol is correct
- Check security type (STK for stocks)
- Ensure symbol is tradeable

### Error Code Reference

| Code | Type | Description |
|------|------|-------------|
| 2104-2106 | Info | Market data farm connection |
| 2158 | Info | Sec-def data farm connection |
| 200 | Error | No security definition |
| 201 | Error | Order rejected |
| 202 | Error | Order cancelled |
| 300+ | Error | System errors |
| 502 | Error | Couldn't connect to TWS |

---

## Testing

### Paper Trading Test

```python
import asyncio
from order_plane.broker.ibkr_exec_client import IBKRExecClient

async def test_paper_trading():
    # Connect to paper trading
    client = IBKRExecClient({
        'host': '127.0.0.1',
        'port': 4002,  # Paper trading port
        'client_id': 2
    })

    connected = await client.connect_async()
    assert connected, "Failed to connect"

    # Place test order (small quantity)
    test_order = {
        'intent_id': 'test-001',
        'symbol': 'SPY',
        'direction': 'BUY',
        'quantity': 1,  # Small test quantity
        'order_type': 'MARKET'
    }

    order_id = await client.place_order(test_order)
    assert order_id is not None, "Failed to place order"

    # Wait for fill
    await asyncio.sleep(5)

    # Check execution reports
    reports = await client.get_execution_reports()
    assert len(reports) > 0, "No execution reports"

    print("✓ Paper trading test passed")

    await client.disconnect_async()

# Run test
asyncio.run(test_paper_trading())
```

---

## Monitoring & Metrics

### Health Check

```python
# Check IBKR connection health
health = ibkr_client.health()

print(f"Connected: {health['connected']}")
print(f"Orders tracked: {health['orders_tracked']}")
print(f"Next order ID: {health['next_order_id']}")
```

### Prometheus Metrics

Exposed on port 8002:

```
# Order placement
order_plane_orders_placed_total{symbol="SPY",side="BUY"}
order_plane_orders_rejected_total{reason="risk_limits"}

# Fills
order_plane_fills_total{symbol="SPY"}
order_plane_fill_latency_seconds

# Errors
order_plane_errors_total{error_code="201"}
```

---

## Production Considerations

### Safety Checks

**Before going live:**
1. ✅ Test thoroughly in paper trading
2. ✅ Verify all risk limits are configured
3. ✅ Enable kill-switches in Strategy Plane
4. ✅ Set reasonable position size limits
5. ✅ Configure monitoring and alerts
6. ✅ Test order cancellation flow
7. ✅ Verify execution report publishing
8. ✅ Set up fallback procedures

### Live Trading Checklist

- [ ] IBKR live account funded
- [ ] API enabled in live TWS
- [ ] Port changed from 4002 to 4001
- [ ] IBKR_READ_ONLY disabled (for live trading)
- [ ] Risk limits configured for live capital
- [ ] Monitoring dashboards set up
- [ ] Alert rules configured
- [ ] Kill-switches tested
- [ ] Runbook procedures documented
- [ ] Team trained on emergency procedures

---

## Support & Resources

### IBKR API Documentation
- API Reference: https://interactivebrokers.github.io/tws-api/
- Order Types: https://www.interactivebrokers.com/en/index.php?f=4985
- Error Codes: https://interactivebrokers.github.io/tws-api/message_codes.html

### Internal Documentation
- [DEPLOYMENT.md](DEPLOYMENT.md) - Deployment guide
- [INCIDENT_PLAYBOOK.md](INCIDENT_PLAYBOOK.md) - Incident response
- [RACI.md](RACI.md) - Roles and responsibilities

---

**Status**: Order execution fully implemented and ready for paper/live trading
**Last Updated**: 2025-11-16
