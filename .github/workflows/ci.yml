name: CI - Tests and Code Quality

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # Unit Tests Job
  # ============================================================================
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc \
            g++ \
            gfortran \
            libopenblas-dev \
            liblapack-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run unit tests with coverage
        run: |
          pytest tests/ \
            -m "unit" \
            --cov=algo_trade \
            --cov=data_plane \
            --cov=order_plane \
            --cov-report=xml \
            --cov-report=term \
            --cov-report=html \
            --junit-xml=test-results-${{ matrix.python-version }}.xml \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: test-results-${{ matrix.python-version }}.xml

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-html-${{ matrix.python-version }}
          path: htmlcov/

  # ============================================================================
  # Integration Tests Job
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    services:
      zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        env:
          ZOOKEEPER_CLIENT_PORT: 2181
          ZOOKEEPER_TICK_TIME: 2000
        ports:
          - 2181:2181

      kafka:
        image: confluentinc/cp-kafka:7.5.0
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        ports:
          - 9092:9092
        options: >-
          --health-cmd="kafka-broker-api-versions --bootstrap-server localhost:9092"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: 'pip'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc g++ libopenblas-dev
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run integration tests
        env:
          KAFKA_BOOTSTRAP_SERVERS: localhost:9092
        run: |
          pytest tests/ \
            -m "integration and not requires_ibkr" \
            --junit-xml=integration-test-results.xml \
            -v

      - name: Upload integration test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: integration-test-results.xml

  # ============================================================================
  # Code Quality Job
  # ============================================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run Black (code formatting)
        run: |
          black --check --diff algo_trade/ data_plane/ order_plane/ tests/
        continue-on-error: true

      - name: Run Flake8 (linting)
        run: |
          flake8 algo_trade/ data_plane/ order_plane/ \
            --max-line-length=120 \
            --exclude=__pycache__,.git,build,dist \
            --statistics
        continue-on-error: true

      - name: Run MyPy (type checking)
        run: |
          mypy algo_trade/ data_plane/ order_plane/ \
            --ignore-missing-imports \
            --no-strict-optional
        continue-on-error: true

      - name: Run Bandit (security)
        run: |
          bandit -r algo_trade/ data_plane/ order_plane/ \
            -f json -o bandit-report.json
        continue-on-error: true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  # ============================================================================
  # Property-Based Tests Job
  # ============================================================================
  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: 'pip'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc g++ libopenblas-dev
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run property-based tests
        env:
          HYPOTHESIS_PROFILE: ci
        run: |
          pytest tests/ \
            -m "property" \
            --junit-xml=property-test-results.xml \
            -v
        continue-on-error: true

      - name: Upload property test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: property-test-results
          path: property-test-results.xml

  # ============================================================================
  # Test Summary Job
  # ============================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, code-quality, property-tests]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Display test summary
        run: |
          echo "==================================="
          echo "CI Pipeline Summary"
          echo "==================================="
          echo ""
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Property Tests: ${{ needs.property-tests.result }}"
          echo ""
          echo "==================================="

      - name: Check for failures
        if: needs.unit-tests.result == 'failure' || needs.integration-tests.result == 'failure'
        run: |
          echo "‚ùå Critical tests failed"
          exit 1
