name: Governance Gate

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  check-risk-params:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for git diff

      - name: Check risk parameter changes
        id: risk_check
        run: |
          echo "Checking for risk parameter changes..."

          # Check if config.py changed
          if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -q "algo_trade/core/config.py"; then
            echo "‚ö†Ô∏è  Config file changed, analyzing risk parameters..."

            # Extract changed risk parameters
            CHANGED_PARAMS=$(git diff origin/${{ github.base_ref }}..HEAD algo_trade/core/config.py | \
              grep -E "^[+-].*(" | \
              grep -E "(KILL_PNL|MAX_DD_KILL_SWITCH|PSR_KILL_SWITCH|BOX_LIM|GROSS_LIM|NET_LIM|VOL_TARGET)" || true)

            if [ -n "$CHANGED_PARAMS" ]; then
              echo "üö® CRITICAL: Risk parameters modified!"
              echo ""
              echo "Changed parameters:"
              echo "$CHANGED_PARAMS"
              echo ""
              echo "risk_params_changed=true" >> $GITHUB_OUTPUT
              echo "changed_params<<EOF" >> $GITHUB_OUTPUT
              echo "$CHANGED_PARAMS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ No critical risk parameters changed"
              echo "risk_params_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚úÖ Config file not modified"
            echo "risk_params_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if risk params changed
        if: steps.risk_check.outputs.risk_params_changed == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const message = `## ‚ö†Ô∏è Risk Parameter Change Detected

            This PR modifies critical risk management parameters. **Manual approval required** from Risk Officer.

            ### Changed Parameters
            \`\`\`diff
            ${{ steps.risk_check.outputs.changed_params }}
            \`\`\`

            ### Required Actions
            - [ ] Risk Officer review and approval
            - [ ] Backtest results with new parameters
            - [ ] Risk impact assessment documentation
            - [ ] Approval in Slack #risk-changes channel

            ### Reviewers
            @risk-officer @cto @lead-quant

            **Note:** This PR will be blocked from merging until risk approval is received.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

            // Add label
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['risk-param-change', 'requires-risk-approval']
            });

      - name: Block merge if risk params changed
        if: steps.risk_check.outputs.risk_params_changed == 'true'
        run: |
          echo "::error::Risk parameter changes require Risk Officer approval"
          echo "Please obtain approval in #risk-changes Slack channel"
          echo "Add 'risk-approved' label to proceed"
          exit 1

  check-schema-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install jsonschema>=4.19.0

      - name: Check for schema breaking changes
        id: schema_check
        run: |
          echo "Checking for schema breaking changes..."

          # Check if any schema files changed
          SCHEMA_CHANGES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E "\.schema\.json$" || true)

          if [ -n "$SCHEMA_CHANGES" ]; then
            echo "üìã Schema files changed:"
            echo "$SCHEMA_CHANGES"
            echo ""
            echo "Analyzing for breaking changes..."

            # This is a placeholder - full implementation would:
            # 1. Parse old and new schemas
            # 2. Check for removed required fields
            # 3. Check for type changes
            # 4. Check for enum value removals
            # 5. Verify backward compatibility

            echo "schema_changed=true" >> $GITHUB_OUTPUT
            echo "breaking_changes=false" >> $GITHUB_OUTPUT  # TODO: Implement actual check

            # For now, just warn
            echo "‚ö†Ô∏è  Schema validation: To be fully implemented"
          else
            echo "‚úÖ No schema changes detected"
            echo "schema_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if schemas changed
        if: steps.schema_check.outputs.schema_changed == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const message = `## üìã Schema Changes Detected

            This PR modifies data contracts/schemas.

            ### Required Verification
            - [ ] Schemas are backward compatible
            - [ ] No breaking changes to existing consumers
            - [ ] Contract tests pass
            - [ ] Migration plan documented (if needed)

            ### Review Checklist
            - [ ] All required fields preserved
            - [ ] No type changes for existing fields
            - [ ] Enum values not removed
            - [ ] Default values provided for new required fields

            **Note:** Breaking schema changes require coordinated deployment.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  check-test-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Verify all test types present
        run: |
          echo "Checking for test coverage..."

          # Check if PR adds new code but no tests
          NEW_CODE=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | \
            grep -E "^(algo_trade|data_plane|order_plane)/.*\.py$" | \
            grep -v "__init__.py" || true)

          NEW_TESTS=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | \
            grep -E "^tests/.*\.py$" || true)

          if [ -n "$NEW_CODE" ] && [ -z "$NEW_TESTS" ]; then
            echo "‚ö†Ô∏è  WARNING: New code added but no tests found"
            echo "Please add appropriate tests for new functionality"
            echo ""
            echo "New code files:"
            echo "$NEW_CODE"
          else
            echo "‚úÖ Tests appear to be included with code changes"
          fi

  verify-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Check for dependency changes
        id: deps_check
        run: |
          if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -q "requirements"; then
            echo "deps_changed=true" >> $GITHUB_OUTPUT
            echo "üì¶ Requirements files changed"
          else
            echo "deps_changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No dependency changes"
          fi

      - name: Install and check dependencies
        if: steps.deps_check.outputs.deps_changed == 'true'
        run: |
          pip install safety pip-audit

          echo "Running safety check..."
          safety check --json --output safety-report.json || true

          echo "Running pip-audit..."
          pip-audit --requirement requirements.txt --format json --output pip-audit-report.json || true

          echo "‚úÖ Dependency security checks complete"

      - name: Upload security reports
        if: steps.deps_check.outputs.deps_changed == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: dependency-security-reports
          path: |
            safety-report.json
            pip-audit-report.json

  # =========================================================================
  # SECRET SCANNING - Prevent credentials from being committed
  # =========================================================================
  secret-scanning:
    runs-on: ubuntu-latest
    name: Secret Detection
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # GitLeaks - Pattern-based secret detection
      - name: GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
        continue-on-error: true
        id: gitleaks

      # detect-secrets - Yelp's secret detection tool
      - name: Install detect-secrets
        run: |
          pip install detect-secrets

      - name: Run detect-secrets scan
        id: detect_secrets
        run: |
          echo "üîç Scanning for secrets with detect-secrets..."

          # Scan all files and compare with baseline
          if [ -f .secrets.baseline ]; then
            detect-secrets scan --baseline .secrets.baseline \
              --exclude-files '\.git/.*' \
              --exclude-files '\.env\.example$' \
              --exclude-files 'tests/.*' > scan-results.json || true

            # Check if new secrets were found
            if grep -q "\"results\":" scan-results.json && [ "$(cat scan-results.json | grep -c '\"results\":')" -gt 0 ]; then
              echo "secrets_found=true" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è  New secrets detected!"
              cat scan-results.json
            else
              echo "secrets_found=false" >> $GITHUB_OUTPUT
              echo "‚úÖ No new secrets detected"
            fi
          else
            echo "‚ö†Ô∏è  No .secrets.baseline found, creating one..."
            detect-secrets scan > .secrets.baseline
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          fi

      # TruffleHog - Additional secret scanning
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      # Scan for hardcoded IPs and sensitive patterns
      - name: Check for hardcoded credentials patterns
        run: |
          echo "üîç Checking for hardcoded credentials patterns..."

          FINDINGS=0

          # Check for common credential patterns in changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep '\.py$' || true)

          if [ -n "$CHANGED_FILES" ]; then
            for file in $CHANGED_FILES; do
              if [ -f "$file" ]; then
                # Check for hardcoded passwords
                if grep -iE "(password|passwd|pwd)\s*=\s*['\"][^'\"]+['\"]" "$file"; then
                  echo "‚ö†Ô∏è  Possible hardcoded password in $file"
                  FINDINGS=$((FINDINGS + 1))
                fi

                # Check for API keys
                if grep -iE "(api[_-]?key|apikey|api[_-]?secret)\s*=\s*['\"][a-zA-Z0-9]{20,}['\"]" "$file"; then
                  echo "‚ö†Ô∏è  Possible API key in $file"
                  FINDINGS=$((FINDINGS + 1))
                fi

                # Check for tokens
                if grep -iE "(token|auth[_-]?token)\s*=\s*['\"][a-zA-Z0-9]{20,}['\"]" "$file"; then
                  echo "‚ö†Ô∏è  Possible token in $file"
                  FINDINGS=$((FINDINGS + 1))
                fi
              fi
            done
          fi

          if [ $FINDINGS -gt 0 ]; then
            echo "‚ùå Found $FINDINGS potential credential issues"
            echo "Please review and use environment variables or Vault instead"
            exit 1
          else
            echo "‚úÖ No hardcoded credentials detected"
          fi

      # Comment on PR if secrets found
      - name: Comment on PR if secrets detected
        if: steps.detect_secrets.outputs.secrets_found == 'true' || steps.gitleaks.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            const message = `## üö® SECURITY ALERT: Secrets Detected!

            This PR contains potential secrets or credentials that should NOT be committed to the repository.

            ### Detected Issues
            - Secret scanning tools detected potential credentials
            - This is a **critical security issue** that must be resolved before merging

            ### Required Actions
            1. **Remove all secrets** from the code
            2. **Revoke/rotate** any exposed credentials immediately
            3. Use one of these alternatives:
               - Environment variables (.env file, NOT committed)
               - HashiCorp Vault (DP_USE_VAULT=1)
               - AWS Secrets Manager
            4. Update .secrets.baseline if false positive:
               \`\`\`bash
               detect-secrets scan > .secrets.baseline
               git add .secrets.baseline
               \`\`\`

            ### Security Best Practices
            - ‚úÖ Use \`.env.example\` for templates (already configured)
            - ‚úÖ Store secrets in environment variables
            - ‚úÖ Use Vault/Secrets Manager for production
            - ‚úÖ Never commit files named \`.env\`, \`secrets.yaml\`, etc.
            - ‚úÖ Install pre-commit hooks: \`pre-commit install\`

            ### Documentation
            - [Secrets Management Guide](./docs/SECURITY.md)
            - [.env.example Template](./.env.example)

            **This PR is BLOCKED until secrets are removed.**
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

            // Add critical label
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security-critical', 'secrets-detected', 'blocked']
            });

      - name: Block merge if secrets found
        if: steps.detect_secrets.outputs.secrets_found == 'true' || steps.gitleaks.outcome == 'failure'
        run: |
          echo "::error::üö® SECRETS DETECTED - Merge blocked for security"
          echo "Secrets or credentials were found in this PR"
          echo "Remove all secrets and use environment variables or Vault instead"
          echo ""
          echo "See the PR comment for detailed remediation steps"
          exit 1

  # =========================================================================
  # SECURITY SCANNING - Bandit for Python security issues
  # =========================================================================
  security-code-scan:
    runs-on: ubuntu-latest
    name: Security Code Analysis
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Bandit
        run: |
          pip install bandit[toml]

      - name: Run Bandit security scan
        id: bandit
        run: |
          echo "üîí Running Bandit security analysis..."

          # Run Bandit with configuration from pyproject.toml
          bandit -c pyproject.toml -r algo_trade/ data_plane/ order_plane/ apps/ contracts/ \
            -f json -o bandit-report.json || true

          # Also generate text report for display
          bandit -c pyproject.toml -r algo_trade/ data_plane/ order_plane/ apps/ contracts/ \
            -f txt -o bandit-report.txt || true

          # Check severity
          HIGH_SEVERITY=$(cat bandit-report.json | grep -c '"issue_severity": "HIGH"' || echo "0")
          MEDIUM_SEVERITY=$(cat bandit-report.json | grep -c '"issue_severity": "MEDIUM"' || echo "0")

          echo "high_issues=$HIGH_SEVERITY" >> $GITHUB_OUTPUT
          echo "medium_issues=$MEDIUM_SEVERITY" >> $GITHUB_OUTPUT

          if [ "$HIGH_SEVERITY" -gt 0 ]; then
            echo "‚ùå Found $HIGH_SEVERITY high severity security issues"
            cat bandit-report.txt
          elif [ "$MEDIUM_SEVERITY" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $MEDIUM_SEVERITY medium severity security issues"
            cat bandit-report.txt
          else
            echo "‚úÖ No significant security issues found"
          fi

      - name: Upload Bandit report
        uses: actions/upload-artifact@v3
        with:
          name: bandit-security-report
          path: |
            bandit-report.json
            bandit-report.txt

      - name: Comment on PR if security issues found
        if: steps.bandit.outputs.high_issues > 0
        uses: actions/github-script@v6
        with:
          script: |
            const high = ${{ steps.bandit.outputs.high_issues }};
            const medium = ${{ steps.bandit.outputs.medium_issues }};

            const message = `## üîí Security Issues Detected

            Bandit security analysis found potential security vulnerabilities:

            - **High Severity**: ${high} issue(s)
            - **Medium Severity**: ${medium} issue(s)

            ### Required Actions
            1. Review the Bandit report in the workflow artifacts
            2. Fix all HIGH severity issues before merging
            3. Address MEDIUM severity issues or document why they're acceptable

            ### Common Issues
            - Hardcoded passwords/secrets
            - SQL injection vulnerabilities
            - Command injection risks
            - Insecure SSL/TLS configuration
            - Use of unsafe functions (eval, exec, pickle)

            Download the full report from the workflow artifacts for details.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: Fail on high severity issues
        if: steps.bandit.outputs.high_issues > 0
        run: |
          echo "::error::High severity security issues found"
          echo "Fix all high severity issues before merging"
          exit 1

  check-documentation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check if docs need update
        run: |
          # Check if significant code changes warrant doc updates
          SIGNIFICANT_CHANGES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | \
            grep -E "^(algo_trade/core|data_plane|order_plane)/.*\.py$" || true)

          DOC_CHANGES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | \
            grep -E "\.md$" || true)

          if [ -n "$SIGNIFICANT_CHANGES" ] && [ -z "$DOC_CHANGES" ]; then
            echo "‚ö†Ô∏è  Significant code changes detected, consider updating documentation"
            echo ""
            echo "Changed modules:"
            echo "$SIGNIFICANT_CHANGES"
            echo ""
            echo "Recommended docs to review:"
            echo "- README.md"
            echo "- QA_PLAN.md"
            echo "- RUNBOOK.md"
          else
            echo "‚úÖ Documentation appears up to date"
          fi

  governance-summary:
    needs: [check-risk-params, check-schema-changes, check-test-coverage, verify-dependencies, secret-scanning, security-code-scan, check-documentation]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Governance checks summary
        run: |
          echo "## üõ°Ô∏è Governance Gate Summary"
          echo ""
          echo "All governance checks completed."
          echo "Review the individual check results above."
          echo ""
          echo "### Security Checks Performed"
          echo "‚úÖ Secret Detection (GitLeaks, detect-secrets, TruffleHog)"
          echo "‚úÖ Security Code Analysis (Bandit)"
          echo "‚úÖ Dependency Vulnerability Scanning (Safety, pip-audit)"
          echo "‚úÖ Risk Parameter Protection"
          echo "‚úÖ Schema Compatibility"
          echo ""
          echo "### Next Steps"
          echo "1. Address any warnings or required approvals"
          echo "2. Fix all security issues (secrets, vulnerabilities)"
          echo "3. Ensure all test suites pass"
          echo "4. Obtain necessary sign-offs"
          echo "5. Proceed with merge when all gates are green"
